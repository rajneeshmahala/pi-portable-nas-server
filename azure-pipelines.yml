trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: $(Agent.TempDirectory)/android-sdk
  ANDROID_HOME: $(Agent.TempDirectory)/android-sdk
  GRADLE_VERSION: 8.5

steps:
# -------------------------------------------------
# Java 17
# -------------------------------------------------
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '17'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'

# -------------------------------------------------
# Install Gradle 8.5
# -------------------------------------------------
- script: |
    wget https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip
    unzip gradle-${GRADLE_VERSION}-bin.zip
    sudo mv gradle-${GRADLE_VERSION} /opt/gradle
    sudo ln -sf /opt/gradle/bin/gradle /usr/bin/gradle
    gradle --version
  displayName: Install Gradle 8.5

# -------------------------------------------------
# Install Android SDK
# -------------------------------------------------
- script: |
    mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
    cd $ANDROID_SDK_ROOT/cmdline-tools

    wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
    unzip commandlinetools-linux-*.zip
    mv cmdline-tools latest

    yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager \
      --sdk_root=$ANDROID_SDK_ROOT \
      "platform-tools" \
      "platforms;android-34" \
      "build-tools;34.0.0"
  displayName: Install Android SDK

# -------------------------------------------------
# Build APK (CRITICAL FIX HERE)
# -------------------------------------------------
- script: |
    export KOTLIN_BUILD_REPORT_ENABLE=false
    export KOTLIN_BUILD_STATISTICS_ENABLE=false
    export GRADLE_OPTS="-Dkotlin.build.report.enable=false -Dkotlin.build.statistic.enable=false"

    gradle -p android-app :app:clean :app:assembleDebug --no-daemon
  displayName: Build Debug APK

# -------------------------------------------------
# Publish APK
# -------------------------------------------------
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: android-app/app/build/outputs/apk/debug
    artifact: DevX-APK
    publishLocation: pipeline